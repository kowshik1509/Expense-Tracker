{% extends "base.html" %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ---------- BACKGROUND ---------- */
.dashboard-bg {
  width: 100%;
  min-height: calc(100vh - 72px);
  padding: 48px 20px 72px;
  background:
    linear-gradient(rgba(248,250,252,.92), rgba(248,250,252,.92)),
    url("https://images.unsplash.com/photo-1519389950473-47ba0277781c?auto=format&fit=crop&w=1920&q=80");
  background-size: cover;
  background-position: center;
}

/* Dark overlay */
[data-theme="dark"] .dashboard-bg {
  background:
    linear-gradient(rgba(2,6,23,.9), rgba(2,6,23,.9)),
    url("https://images.unsplash.com/photo-1519389950473-47ba0277781c?auto=format&fit=crop&w=1920&q=80");
}

.dashboard {
  max-width: 1100px;
  margin: auto;
}

/* ---------- HEADERS ---------- */
.welcome {
  font-weight: 900;
  font-size: 26px;
  margin-bottom: 28px;
  color: var(--text-main);
}

/* ---------- GRID ---------- */
.dashboard-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 28px;
}

@media (max-width: 820px) {
  .dashboard-grid {
    grid-template-columns: 1fr;
  }
}

/* ---------- CARDS ---------- */
.dash-card {
  background: var(--card-bg);
  border-radius: 18px;
  padding: 26px;
  box-shadow: 0 20px 45px rgba(0,0,0,.18);
  animation: fadeIn .35s ease-in-out;
  display: flex;
  flex-direction: column;
}

.dash-card h3 {
  color: var(--text-main);
  font-weight: 800;
  margin-bottom: 14px;
}

/* ---------- PIE CHART ---------- */
.chart-wrap {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
}

#expenseChart {
  max-width: 300px;
  max-height: 300px;
}

/* ---------- SUMMARY CARD ---------- */
.summary-card {
  text-align: center;
  justify-content: center;
}

.summary-card h4 {
  margin-top: 14px;
  color: var(--text-muted);
}

.amount {
  font-size: 40px;
  font-weight: 900;
  color: var(--primary);
  margin: 10px 0;
}

.count {
  font-size: 30px;
  font-weight: 900;
  color: var(--accent-2, #22c55e);
}

/* ---------- ANIMATION ---------- */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* ---------- MOBILE OPTIMIZATION ---------- */
@media (max-width: 520px) {
  .dash-card {
    padding: 22px;
    border-radius: 14px;
  }
  #expenseChart {
    max-width: 240px;
    max-height: 240px;
  }
  .amount { font-size: 32px; }
  .count { font-size: 26px; }
}

/* Reduce heavy bg rendering on very small devices */
@media (max-width: 480px) {
  .dashboard-bg {
    background-attachment: scroll;
    background-size: 900px auto;
  }
}
</style>

<div class="dashboard-bg">
  <div class="dashboard">

    <h2 class="welcome">Welcome back, {{ username }}</h2>

    <div class="dashboard-grid">

      <div class="dash-card">
        <h3>ðŸ“Š Expenses by Category</h3>
        <div class="chart-wrap">
          <canvas id="expenseChart"></canvas>
        </div>
      </div>

      <div class="dash-card summary-card">
        <h3>Total Expenses</h3>
        <div class="amount">â‚¹ {{ grand_total }}</div>

        <h4>Categories Used</h4>
        <div class="count">{{ categories|length }}</div>
      </div>

    </div>
  </div>
</div>

<script>
/* ----- Read theme colors from CSS vars (auto-theme) ----- */
function cssVar(name){
  return getComputedStyle(document.body).getPropertyValue(name).trim();
}

const ctx = document.getElementById("expenseChart");
const legendColor = cssVar("--text-main") || "#e5e7eb";

/* ----- Chart.js Pie (theme-aware) ----- */
const chart = new Chart(ctx, {
  type: "pie",
  data: {
    labels: {{ categories|tojson|safe }},
    datasets: [{
      data: {{ totals|tojson|safe }},
      backgroundColor: [
        cssVar("--primary"),
        cssVar("--accent"),
        cssVar("--accent-2"),
        "#f59e0b",
        "#ef4444",
        "#8b5cf6"
      ],
      borderColor: "transparent"
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: "bottom",
        labels: {
          color: legendColor,
          font: { size: 13, weight: "bold" }
        }
      }
    }
  }
});

/* ----- Update colors when theme changes ----- */
new MutationObserver(() => {
  chart.options.plugins.legend.labels.color = cssVar("--text-main");
  chart.data.datasets[0].backgroundColor[0] = cssVar("--primary");
  chart.data.datasets[0].backgroundColor[1] = cssVar("--accent");
  chart.data.datasets[0].backgroundColor[2] = cssVar("--accent-2");
  chart.update();
}).observe(document.body, { attributes: true, attributeFilter: ["data-theme"] });
</script>

{% endblock %}
