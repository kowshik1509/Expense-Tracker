{% extends "base.html" %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>

/* ---------- PAGE BACKDROP ---------- */
.dashboard-bg{
  width:100%;
  min-height:calc(100vh - 72px);
  padding:48px 20px 72px;
  background:
    linear-gradient(rgba(248,250,252,.94),rgba(248,250,252,.94)),
    url("https://images.unsplash.com/photo-1519389950473-47ba0277781c?auto=format&fit=crop&w=1920&q=80");
  background-size:cover;
  background-position:center;
}
[data-theme="dark"] .dashboard-bg{
  background:
    linear-gradient(rgba(2,6,23,.90),rgba(2,6,23,.90)),
    url("https://images.unsplash.com/photo-1519389950473-47ba0277781c?auto=format&fit=crop&w=1920&q=80");
}

/* ---------- GLASS CARD BASE ---------- */
.glass{
  background:rgba(255,255,255,.78);
  backdrop-filter:blur(14px);
  -webkit-backdrop-filter:blur(14px);
  border:1px solid rgba(255,255,255,.65);
}
[data-theme="dark"] .glass{
  background:rgba(17,24,39,.82);
  border:1px solid rgba(255,255,255,.12);
}

.dashboard{max-width:1100px;margin:auto}

/* ---------- HEADER ---------- */
.welcome{
  font-size:26px;
  font-weight:900;
  margin-bottom:30px;
}

/* ---------- GRID ---------- */
.dashboard-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:28px;
}
@media(max-width:820px){
  .dashboard-grid{grid-template-columns:1fr}
}

/* ---------- CARD ---------- */
.dash-card{
  @apply glass;
  border-radius:20px;
  padding:26px;
  box-shadow:0 26px 60px rgba(0,0,0,.25);
  animation:fadeIn .35s ease;
  display:flex;
  flex-direction:column;
  transition:transform .25s, box-shadow .25s;
}
.dash-card:hover{
  transform:translateY(-2px);
  box-shadow:0 30px 70px rgba(0,0,0,.30);
}
.dash-card h3{
  margin-bottom:14px;
  font-weight:900;
}

/* ---------- PIE CHART ---------- */
.chart-wrap{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
}
#expenseChart{max-width:300px;max-height:300px}

/* ---------- SUMMARY CARD ---------- */
.summary-card{text-align:center}
.amount{
  font-size:40px;
  font-weight:900;
  color:var(--primary);
  margin:8px 0 6px;
}
.count{
  font-size:30px;
  font-weight:900;
  color:var(--accent-2,#22c55e);
}
.summary-card h4{
  margin-top:14px;
  color:var(--text-muted);
}

/* ---------- ANIM ---------- */
@keyframes fadeIn{
  from{opacity:0;transform:translateY(8px)}
  to{opacity:1;transform:translateY(0)}
}
@media(max-width:520px){
  .dash-card{padding:22px;border-radius:16px}
  #expenseChart{max-width:240px;max-height:240px}
  .amount{font-size:32px}
  .count{font-size:26px}
}
@media(max-width:480px){
  .dashboard-bg{background-attachment:scroll;background-size:900px auto}
}
</style>

<div class="dashboard-bg">
  <div class="dashboard">

    <h2 class="welcome">Welcome back, {{ username }}</h2>

    <div class="dashboard-grid">

      <!-- ðŸ“Š CATEGORY CHART -->
      <div class="dash-card glass">
        <h3>Expense Breakdown</h3>
        <div class="chart-wrap">
          <canvas id="expenseChart"></canvas>
        </div>
      </div>

      <!-- ðŸ§¾ SUMMARY -->
      <div class="dash-card glass summary-card">
        <h3>Overview</h3>

        <div class="amount">â‚¹ {{ grand_total }}</div>
        <div class="label">Total Expenses</div>

        <h4>Categories Used</h4>
        <div class="count">{{ categories|length }}</div>
      </div>

    </div>
  </div>
</div>

<script>
function cssVar(name){
  return getComputedStyle(document.body).getPropertyValue(name).trim();
}
const ctx = document.getElementById("expenseChart");
const chart = new Chart(ctx,{
  type:"pie",
  data:{
    labels: {{ categories|tojson|safe }},
    datasets:[{
      data: {{ totals|tojson|safe }},
      backgroundColor:[
        cssVar("--primary"),
        cssVar("--accent"),
        cssVar("--accent-2"),
        "#f59e0b","#ef4444","#8b5cf6"
      ],
      borderColor:"transparent"
    }]
  },
  options:{
    responsive:true,
    maintainAspectRatio:false,
    animation:{ animateRotate:true, animateScale:true },
    plugins:{
      legend:{
        position:"bottom",
        labels:{ color:cssVar("--text-main"), font:{ size:13, weight:"bold" } }
      }
    }
  }
});

/* live theme update */
new MutationObserver(() => {
  chart.options.plugins.legend.labels.color = cssVar("--text-main");
  const c = chart.data.datasets[0].backgroundColor;
  c[0]=cssVar("--primary"); c[1]=cssVar("--accent"); c[2]=cssVar("--accent-2");
  chart.update();
}).observe(document.body,{ attributes:true, attributeFilter:["data-theme"] });
</script>

{% endblock %}
