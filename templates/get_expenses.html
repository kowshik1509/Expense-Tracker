{% extends "base.html" %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>

/* ---------- PAGE BACKDROP ---------- */
.analytics-bg{
  width:100%;
  min-height:calc(100vh - 72px);
  padding:44px 18px 64px;
  background:
    linear-gradient(rgba(248,250,252,.94),rgba(248,250,252,.94)),
    url("https://images.unsplash.com/photo-1520607162513-77705c0f0d4a?auto=format&fit=crop&w=1920&q=80");
  background-size:cover;
  background-position:center;
}

[data-theme="dark"] .analytics-bg{
  background:
    linear-gradient(rgba(2,6,23,.90),rgba(2,6,23,.90)),
    url("https://images.unsplash.com/photo-1520607162513-77705c0f0d4a?auto=format&fit=crop&w=1920&q=80");
}

/* ---------- FORM CARD ---------- */
.expense-page{
  display:flex;
  justify-content:center;
  align-items:center;
  margin-bottom:40px;
}

.expense-card{
  background:var(--card-bg);
  width:480px;
  max-width:100%;
  padding:32px;
  border-radius:18px;
  box-shadow:0 22px 45px rgba(0,0,0,.18);
  text-align:center;
  animation:fadeIn .35s ease-in-out;
}

.expense-title{
  font-size:24px;
  font-weight:800;
  margin-bottom:6px;
  background:linear-gradient(90deg,var(--primary),var(--accent));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}

.expense-subtitle{
  font-size:14px;
  color:var(--text-muted);
  margin-bottom:24px;
}

/* ---------- FORM INPUTS ---------- */
label{
  display:block;
  text-align:left;
  font-size:13px;
  font-weight:600;
  color:var(--text-main);
  margin-bottom:6px;
}

.expense-card input{
  width:100%;
  padding:12px;
  margin-bottom:18px;
  border-radius:10px;
  border:1px solid var(--border);
  font-size:14px;
  background:var(--card-bg);
  color:var(--text-main);
}

.expense-card input:focus{
  border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(79,70,229,.22);
  outline:none;
}

.expense-card button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:12px;
  background:linear-gradient(135deg,var(--primary),var(--accent));
  color:#fff;
  font-size:15px;
  font-weight:700;
  cursor:pointer;
}

/* ---------- CHART CARD ---------- */
.chart-section{
  display:flex;
  justify-content:center;
  margin-bottom:40px;
}

.chart-card{
  background:var(--card-bg);
  width:480px;
  max-width:100%;
  padding:28px;
  border-radius:18px;
  box-shadow:0 22px 45px rgba(0,0,0,.18);
  text-align:center;
}

.chart-title{
  font-size:16px;
  font-weight:800;
  color:var(--text-main);
  margin-bottom:14px;
}

.chart-wrap{
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:240px;
}

#expenseChart{
  max-width:260px;
  max-height:260px;
}

.chart-summary{
  font-size:14px;
  font-weight:600;
  color:var(--text-muted);
  margin-top:10px;
}

.chart-summary span{
  display:block;
  font-size:22px;
  font-weight:900;
  color:var(--accent-2,#22c55e);
  margin-top:6px;
}

/* ---------- RESULTS TABLE ---------- */
.results-section{
  max-width:1150px;
  margin:0 auto;
  background:var(--card-bg);
  padding:28px 30px;
  border-radius:20px;
  box-shadow:0 26px 55px rgba(0,0,0,.22);
}

.results-title{
  font-size:18px;
  font-weight:900;
  color:var(--text-main);
  margin-bottom:14px;
}

.table-wrapper{
  overflow-x:auto;
}

.expense-table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
  min-width:720px;
}

.expense-table th{
  background:linear-gradient(135deg,var(--primary),var(--accent));
  color:#fff;
  padding:14px;
  text-align:left;
}

.expense-table td{
  padding:14px;
  color:var(--text-main);
  border-bottom:1px solid var(--border);
}

.expense-table tbody tr:nth-child(even){
  background:var(--row-alt,#f8fafc);
}

[data-theme="dark"] .expense-table tbody tr:nth-child(even){
  background:rgba(255,255,255,.05);
}

.expense-table tbody tr:hover{
  background:rgba(79,70,229,.08);
}

.expense-table td:last-child{
  font-weight:800;
  color:var(--accent-2,#22c55e);
}

.no-data{
  text-align:center;
  font-size:14px;
  color:var(--text-muted);
  padding:22px 0;
}

/* ---------- ANIMATION ---------- */
@keyframes fadeIn{
  from{opacity:0;transform:translateY(8px)}
  to{opacity:1;transform:translateY(0)}
}

/* ---------- MOBILE ---------- */
@media(max-width:520px){
  .expense-card,.chart-card{
    padding:22px;
    border-radius:14px;
  }
  .expense-title{font-size:20px}
  .chart-wrap{min-height:200px}
}

/* reduce heavy bg paint on small screens */
@media(max-width:480px){
  .analytics-bg{
    background-attachment:scroll;
    background-size:900px auto;
  }
}
</style>

<div class="analytics-bg">

  <!-- FORM -->
  <div class="expense-page">
    <div class="expense-card">
      <div class="expense-title">Expense Analytics</div>
      <div class="expense-subtitle">Analyze expenses by date range</div>

      <form method="POST">
        <label>From Date</label>
        <input type="date" name="from_date" required>

        <label>To Date</label>
        <input type="date" name="to_date" required>

        <label>Password</label>
        <input type="password" name="password" required>

        <button type="submit">Fetch Expenses</button>
      </form>
    </div>
  </div>

  <!-- CHART -->
  {% if categories is defined and categories|length > 0 %}
  <div class="chart-section">
    <div class="chart-card">
      <div class="chart-title">Expenses by Category</div>
      <div class="chart-wrap">
        <canvas id="expenseChart"></canvas>
      </div>

      <div class="chart-summary">
        Total Expenses
        <span>â‚¹ {{ grand_total }}</span>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- RESULTS -->
  {% if expenses is defined %}
  <div class="results-section">
    <div class="results-title">Expense Results</div>

    {% if expenses|length > 0 %}
    <div class="table-wrapper">
      <table class="expense-table">
        <thead>
          <tr>
            <th>Expense Id</th>
            <th>Date</th>
            <th>Category</th>
            <th>Description</th>
            <th>Amount</th>
          </tr>
        </thead>
        <tbody>
          {% for row in expenses %}
          <tr>
            <td>{{ row.expense_id }}</td>
            <td>{{ row.log_creation_date }}</td>
            <td>{{ row.category }}</td>
            <td>{{ row.description }}</td>
            <td>{{ row.amount }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="no-data">No expenses found for this date range.</div>
    {% endif %}
  </div>
  {% endif %}
</div>

{% if categories is defined and categories|length > 0 %}
<script>
/* Theme-aware color getter */
function cssVar(name){
  return getComputedStyle(document.body).getPropertyValue(name).trim();
}

const ctx = document.getElementById("expenseChart");
const legendColor = cssVar("--text-main") || "#e5e7eb";

const chart = new Chart(ctx,{
  type:"pie",
  data:{
    labels: {{ categories|tojson|safe }},
    datasets:[{
      data: {{ totals|tojson|safe }},
      backgroundColor:[
        cssVar("--primary"),
        cssVar("--accent"),
        cssVar("--accent-2"),
        "#f59e0b",
        "#ef4444",
        "#8b5cf6"
      ],
      borderColor:"transparent"
    }]
  },
  options:{
    responsive:true,
    maintainAspectRatio:false,
    plugins:{
      legend:{
        position:"bottom",
        labels:{ color:legendColor }
      }
    }
  }
});

/* Auto-update colors when theme changes */
new MutationObserver(() => {
  chart.options.plugins.legend.labels.color = cssVar("--text-main");
  chart.data.datasets[0].backgroundColor[0] = cssVar("--primary");
  chart.data.datasets[0].backgroundColor[1] = cssVar("--accent");
  chart.data.datasets[0].backgroundColor[2] = cssVar("--accent-2");
  chart.update();
}).observe(document.body,{ attributes:true, attributeFilter:["data-theme"] });
</script>
{% endif %}

{% endblock %}
