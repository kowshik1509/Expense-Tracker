{% extends "base.html" %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>

/* ---------- PAGE BACKDROP ---------- */
.analytics-bg{
  width:100%;
  min-height:calc(100vh - 72px);
  padding:48px 18px 72px;
  background:
    linear-gradient(rgba(248,250,252,.94),rgba(248,250,252,.94)),
    url("https://images.unsplash.com/photo-1520607162513-77705c0f0d4a?auto=format&fit=crop&w=1920&q=80");
  background-size:cover;
  background-position:center;
}
[data-theme="dark"] .analytics-bg{
  background:
    linear-gradient(rgba(2,6,23,.90),rgba(2,6,23,.90)),
    url("https://images.unsplash.com/photo-1520607162513-77705c0f0d4a?auto=format&fit=crop&w=1920&q=80");
}

/* ---------- GLASS CARD BASE ---------- */
.glass{
  background:rgba(255,255,255,.78);
  backdrop-filter:blur(14px);
  -webkit-backdrop-filter:blur(14px);
  border:1px solid rgba(255,255,255,.65);
}
[data-theme="dark"] .glass{
  background:rgba(17,24,39,.82);
  border:1px solid rgba(255,255,255,.12);
}

/* ---------- FORM CARD ---------- */
.expense-page{
  display:flex;
  justify-content:center;
  align-items:center;
  margin-bottom:40px;
}
.expense-card{
  @apply glass;
  width:520px;
  max-width:100%;
  padding:32px;
  border-radius:20px;
  box-shadow:0 26px 60px rgba(0,0,0,.25);
  text-align:center;
  animation:fadeIn .35s ease;
}
.expense-title{
  font-size:22px;
  font-weight:900;
  background:linear-gradient(90deg,var(--primary),var(--accent));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  margin-bottom:4px;
}
.expense-subtitle{
  font-size:13px;
  color:var(--text-muted);
  margin-bottom:22px;
}

/* ---------- FORM ---------- */
label{
  display:block;
  text-align:left;
  font-size:13px;
  font-weight:700;
  margin-bottom:6px;
}
.expense-card input{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid var(--border);
  background:var(--card-bg);
  color:var(--text-main);
  margin-bottom:16px;
  transition:border .2s, box-shadow .2s;
}
.expense-card input:focus{
  border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(79,70,229,.28);
  outline:none;
}
.expense-card button{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:0;
  background:linear-gradient(135deg,var(--primary),var(--accent));
  color:#fff;
  font-size:15px;
  font-weight:800;
  cursor:pointer;
  transition:transform .2s, box-shadow .2s;
}
.expense-card button:hover{
  transform:translateY(-1px);
  box-shadow:0 14px 28px rgba(79,70,229,.38);
}

/* ---------- CHART CARD ---------- */
.chart-section{
  display:flex;
  justify-content:center;
  margin-bottom:40px;
}
.chart-card{
  @apply glass;
  width:520px;
  max-width:100%;
  padding:28px;
  border-radius:20px;
  box-shadow:0 26px 60px rgba(0,0,0,.25);
  text-align:center;
}
.chart-title{
  font-size:15px;
  font-weight:900;
  color:var(--text-main);
  margin-bottom:12px;
}
.chart-wrap{
  min-height:240px;
  display:flex;
  justify-content:center;
  align-items:center;
}
#expenseChart{max-width:280px;max-height:280px}
.chart-summary{
  margin-top:10px;
  font-size:13px;
  color:var(--text-muted);
}
.chart-summary span{
  display:block;
  font-size:24px;
  font-weight:900;
  color:var(--accent-2,#22c55e);
}

/* ---------- RESULTS TABLE ---------- */
.results-section{
  max-width:1150px;
  margin:0 auto;
  padding:30px 32px;
  border-radius:22px;
  @apply glass;
  box-shadow:0 30px 70px rgba(0,0,0,.28);
}
.results-title{
  font-size:18px;
  font-weight:900;
  margin-bottom:14px;
}
.table-wrapper{overflow-x:auto}
.expense-table{
  width:100%;
  min-width:760px;
  border-collapse:collapse;
  font-size:14px;
}
.expense-table th{
  padding:14px;
  text-align:left;
  color:#fff;
  background:linear-gradient(135deg,var(--primary),var(--accent));
}
.expense-table td{
  padding:14px;
  border-bottom:1px solid var(--border);
}
.expense-table tbody tr:nth-child(even){
  background:rgba(0,0,0,.04);
}
[data-theme="dark"] .expense-table tbody tr:nth-child(even){
  background:rgba(255,255,255,.06);
}
.expense-table tbody tr:hover{
  background:rgba(79,70,229,.1);
}
.expense-table td:last-child{
  font-weight:900;
  color:var(--accent-2,#22c55e);
}
.no-data{
  padding:22px 0;
  text-align:center;
  color:var(--text-muted);
}

/* ---------- ANIM ---------- */
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

@media(max-width:520px){
  .expense-card,.chart-card{padding:22px;border-radius:16px}
  .expense-title{font-size:19px}
}
@media(max-width:480px){
  .analytics-bg{background-attachment:scroll;background-size:900px auto}
}
</style>

<div class="analytics-bg">

  <!-- FORM -->
  <div class="expense-page">
    <div class="expense-card glass">
      <div class="expense-title">Expense Analytics</div>
      <div class="expense-subtitle">Analyze spending across any date range</div>

      <form method="POST">
        <label>From Date</label>
        <input type="date" name="from_date" required>

        <label>To Date</label>
        <input type="date" name="to_date" required>

        <label>Password</label>
        <input type="password" name="password" required>

        <button type="submit">Fetch Expenses</button>
      </form>
    </div>
  </div>

  <!-- CHART -->
  {% if categories is defined and categories|length > 0 %}
  <div class="chart-section">
    <div class="chart-card glass">
      <div class="chart-title">Expenses by Category</div>
      <div class="chart-wrap">
        <canvas id="expenseChart"></canvas>
      </div>
      <div class="chart-summary">
        Total Expenses
        <span>â‚¹ {{ grand_total }}</span>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- RESULTS TABLE -->
  {% if expenses is defined %}
  <div class="results-section glass">
    <div class="results-title">Expense Results</div>

    {% if expenses|length > 0 %}
    <div class="table-wrapper">
      <table class="expense-table">
        <thead>
          <tr>
            <th>Expense Id</th>
            <th>Date</th>
            <th>Category</th>
            <th>Description</th>
            <th>Amount</th>
          </tr>
        </thead>
        <tbody>
          {% for row in expenses %}
          <tr>
            <td>{{ row.expense_id }}</td>
            <td>{{ row.log_creation_date }}</td>
            <td>{{ row.category }}</td>
            <td>{{ row.description }}</td>
            <td>{{ row.amount }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="no-data">No expenses found for this date range.</div>
    {% endif %}
  </div>
  {% endif %}
</div>

{% if categories is defined and categories|length > 0 %}
<script>
function cssVar(name){
  return getComputedStyle(document.body).getPropertyValue(name).trim();
}
const ctx = document.getElementById("expenseChart");
const chart = new Chart(ctx,{
  type:"pie",
  data:{
    labels: {{ categories|tojson|safe }},
    datasets:[{
      data: {{ totals|tojson|safe }},
      backgroundColor:[
        cssVar("--primary"),
        cssVar("--accent"),
        cssVar("--accent-2"),
        "#f59e0b","#ef4444","#8b5cf6"
      ],
      borderColor:"transparent"
    }]
  },
  options:{
    responsive:true,
    maintainAspectRatio:false,
    animation:{ animateRotate:true, animateScale:true },
    plugins:{
      legend:{
        position:"bottom",
        labels:{ color:cssVar("--text-main") }
      }
    }
  }
});

/* live theme update */
new MutationObserver(() => {
  chart.options.plugins.legend.labels.color = cssVar("--text-main");
  const c = chart.data.datasets[0].backgroundColor;
  c[0]=cssVar("--primary"); c[1]=cssVar("--accent"); c[2]=cssVar("--accent-2");
  chart.update();
}).observe(document.body,{ attributes:true, attributeFilter:["data-theme"] });
</script>
{% endif %}

{% endblock %}
